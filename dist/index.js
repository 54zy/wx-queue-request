!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t["wx-queue-request"]=e()}(this,function(){"use strict";function t(t){return function(e){s.push(function(n){var r=e.complete;e.complete=function(){n(),"function"==typeof r&&r.apply(void 0,arguments)},t(e)})}}function e(){var e=wx.request;Object.defineProperty(wx,"request",{get:function(){return t(e)}})}var n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(null==t)t=1;else if(0===t)throw new Error("Concurrency must not be zero");return t},u=function(t){if(null!=t.callback&&"function"!=typeof t.callback)throw new Error("task callback must be a function")},s=new(function(){function t(e,r){var u=this;n(this,t),this.queue=e,this._concurrency=i(r),this.buffer=this._concurrency/4,Object.defineProperties(this,{concurrency:{get:function(){return u._concurrency},set:function(t){u._concurrency=t,u.buffer=u._concurrency/4,u.bulk()}},started:{get:function(){return!u.idle()}}}),this._workers=[],this._workersList=[],this._idle=!0,this.paused=!1,this.enableDrain=!0,this.bulk()}return r(t,[{key:"bulk",value:function(){var t=this;setTimeout(function(){var e=Math.min(t._concurrency,t._workers.length);if(e)for(var n=0;n<e;n++)t.next();else t._drain()},0)}},{key:"run",value:function(t){function e(){if(e.called)throw new Error("Callback was already called");e.called=!0,this.pull(t);for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];r&&r[0]&&r[0]instanceof Error&&"function"==typeof this.error&&this.error.apply(this,r.concat([t.task])),"function"==typeof t.callback&&t.callback.apply(t,r),this._workersList.length<=this._concurrency-this.buffer&&"function"==typeof this.unsaturated&&this.unsaturated(),this._drain(),this.next()}this.queue(t.task,e.bind(this))}},{key:"push",value:function(t,e){var n=this;this._idle=!1,(Array.isArray(t)?t:[t]).forEach(function(t){var r={task:t,callback:e};u(r),n._workers.push(r)})}},{key:"next",value:function(){if(!this.paused&&this.concurrency>this._workersList.length&&this._workers.length){var t=this._workers.shift();t&&(this._workersList.push(t),0===this._workers.length&&"function"==typeof this.empty&&this.empty(),this._workersList.length===this._concurrency&&"function"==typeof this.saturated&&this.saturated(),this.run(t))}}},{key:"length",value:function(){return this._workers.length}},{key:"workersList",value:function(){return this._workersList}},{key:"pull",value:function(t){var e=this._workersList.indexOf(t);-1!==e&&this._workersList.splice(e,1)}},{key:"running",value:function(){return this._workersList.length}},{key:"unshift",value:function(t,e){var n=this;this._idle=!1,(Array.isArray(t)?t:[t]).forEach(function(t){var r={task:t,callback:e};u(r),n._workers.unshift(r)})}},{key:"idle",value:function(){return this._idle}},{key:"pause",value:function(){this.paused=!0}},{key:"resume",value:function(){this.paused=!1,this.bulk()}},{key:"kill",value:function(){this.enableDrain=!1,this._workers.length=0,this._idle=!0}},{key:"_drain",value:function(){0===this._workersList.length&&0===this._workers.length&&"function"==typeof this.drain&&(this._idle=!0,this.enableDrain&&this.drain())}},{key:"remove",value:function(t){this._workers=this._workers.filter(function(e,n){var r={data:e.task,priority:n};return!t(r)})}}]),t}())(function(t,e){return t(e)},10);return{queueRequest:t,queue:e}});
